<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Christmas Draw</title>

    <style>
      div#go {
        border-radius: 50%;
        border: 4px solid black;
        display: inline-block;
        text-align: center;
        margin: 0 auto;
        height: 100px;
        width: 100px;
        background-image: url("https://www.nicepng.com/png/detail/51-519773_christmas-tree-comments-christmas-tree-svg-free.png");
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        background-color: rgb(246, 246, 246);
        cursor: pointer;
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="go"></div>
    <script type="module">
      // Import the functions from the SDKs
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        doc,
        getDocs,
        getDoc,
        onSnapshot,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-firestore.js";

      // web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAeCFX7erQWHoU5docTN7JKJQ8d5Gz6I6s",
        authDomain: "sketch-and-code-website.firebaseapp.com",
        databaseURL: "https://sketch-and-code-website.firebaseio.com",
        projectId: "sketch-and-code-website",
        storageBucket: "sketch-and-code-website.appspot.com",
        messagingSenderId: "867551653933",
        appId: "1:867551653933:web:d99668e756059779a848a4",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore();

      let stateDoc;
      let state;
      let lastState;

      function getState() {
        return new Promise(async (resolve, reject) => {
          stateDoc = await doc(db, "christmas-draw", "state");
          const subscription = onSnapshot(stateDoc, (doc) => {
            const source = doc.metadata.hasPendingWrites ? "Local" : "Server";
            if (source === "Server" || !state) {
              if (!state) var mustResolve = true;
              updateLocalState(doc.data());
              if (mustResolve) resolve();
            }
          });
        });
      }

      function updateLocalState(newState) {
        lastState = state;
        state = newState;
        console.log("new state: ", state);
        render();
      }

      async function updateServerState(newState) {
        await setDoc(stateDoc, newState);
      }

      // switch between sheas and schneiders
      function selectFamily(familyName) {
        lastState = state;
        state.familyName = familyName;
        state.givers =
          familyName === "sheas" ? [...state.sheas] : [...state.schneiders];
        state.recipients =
          familyName === "sheas" ? [...state.sheas] : [...state.schneiders];
        apply();
      }

      function apply() {
        updateServerState(state);
        render();
      }

      function recordSelection({ giver, recipient }) {
        const { givers, recipients, selected } = state;
        // record selection
        selected.push({ giver, recipient });
        // remove giver from remaining givers
        givers.splice(
          givers.findIndex((g) => g.name === giver.name),
          1
        );
        // remove recipient from remaining recipients
        recipients.splice(
          recipients.findIndex((r) => r.name === recipient.name),
          1
        );
        apply();
      }

      // returns a psuedo-random integer between 0 and the number that is passed. Pass a positive integer unless you want un-intended behavior.
      function randomize(range) {
        return Math.floor(Math.random() * range);
      }

      function matchFamily() {
        const { givers, recipients } = state;
        const giver = givers[randomize(givers.length)];
        // console.log(giver);
        const eligibleRecipients = recipients
          .map((r) => {
            // cannot gift to yourself
            if (r.name === giver.name) return null;
            // cannot gift to someone in the same family unit
            // also, givers who are not in a family group should not be matched
            // with recipients who are not in a family group, because those are the least
            // restricted givers and recievers - save them to match with more restricted givers
            if (giver.familyGroup === r.familyGroup) return null;
            return r;
          })
          .filter((x) => x);
        // console.log(eligibleRecipients);
        const i = randomize(eligibleRecipients.length);
        // console.log(i);
        const recipient = eligibleRecipients[i];
        // console.log(recipient);

        // this logic has a weird edge case where, if all the eligible recipients for a giver have already been randomly claimed before that giver is evaluated, a giver may not have any eligible recipients. I don't have an elegant solution for this issue, so in this case throw a warning and start over.
        if (!giver || !recipient)
          console.error(
            "An error occurred - giver or recipient is falsy. Please start over."
          );
        return { giver, recipient };
      }

      function getMatch() {
        console.log("getting match");
        console.log(state);
        if (!state.givers.length) return null;
        lastState = state;
        const selection = matchFamily();
        recordSelection(selection);
      }

      function render() {
        // TODO: trigger animations on specific state changes?
        // TODO: populate DOM elements showing the list of selections
      }

      async function setup() {
        await getState();
        if (!state) {
          await updateServerState(defaultState);
        }
        document.getElementById("go").style.display = "block";
        document.getElementById("go").addEventListener("click", getMatch);
        // TODO: add event listener to call selectFamily()
      }

      // expose command to reset app state to the browser
      window.resetState = function () {
        updateServerState(defaultState);
      };

      setup();

      const sheas = [
        {
          name: "John Shea",
          familyGroup: "GA",
        },
        {
          name: "Monica Shook",
          familyGroup: "WI",
        },
        {
          name: "Angela Harris",
          familyGroup: "OH",
        },
        {
          name: "Mary Shea",
          familyGroup: "GA",
        },
        {
          name: "John Shook",
          familyGroup: "WI",
        },
        {
          name: "Ethan Harris",
          familyGroup: "OH",
        },
        {
          name: "James Shea",
          familyGroup: "GA",
        },
        {
          name: "Robert Shea",
          familyGroup: "GA",
        },
        {
          name: "Jack Harris",
          familyGroup: "OH",
        },
        {
          name: "Trevelyan Shook",
          familyGroup: "WI",
        },
        {
          name: "Gregory Shea",
          familyGroup: "GA",
        },
        {
          name: "Finnegan Shook",
          familyGroup: "WI",
        },
        {
          name: "Michael Shea",
        },
        {
          name: "Paul Shea",
        },
        {
          name: "Jacqueline Shea",
        },
      ];
      const schneiders = [
        {
          name: "Rose Schneider",
          familyGroup: "IA",
        },
        {
          name: "Sandra Tully",
          familyGroup: "CA",
        },
        {
          name: "Michael Schneider",
          familyGroup: "OH",
        },
        {
          name: "Mary Shea",
          familyGroup: "GA",
        },
        {
          name: "Elizabeth Kawa",
          familyGroup: "NE",
        },
        {
          name: "Diana Schneider",
          familyGroup: "IA",
        },
        {
          name: "John Tully",
          familyGroup: "CA",
        },
        {
          name: "Kori Schneider",
          familyGroup: "OH",
        },
        {
          name: "John Shea",
          familyGroup: "GA",
        },
        {
          name: "Kevin Kawa",
          familyGroup: "NE",
        },
        {
          name: "Aiden Schneider-Holzer",
          familyGroup: "IA",
        },
        {
          name: "Michaela Schneider",
          familyGroup: "OH",
        },
        {
          name: "Tiffany Schneider",
          familyGroup: "OH",
        },
        {
          name: "Sophie Schneider",
          familyGroup: "OH",
        },
        {
          name: "Brandon Schneider",
          familyGroup: "OH",
        },
        {
          name: "Matthew Schneider",
          familyGroup: "OH",
        },
        {
          name: "James Shea",
          familyGroup: "GA",
        },
        {
          name: "Finnian Schneider",
          familyGroup: "IA",
        },
        {
          name: "Francis Tully",
          familyGroup: "CA",
        },
        {
          name: "David Tully",
          familyGroup: "CA",
        },
        {
          name: "Robert Shea",
          familyGroup: "GA",
        },
        {
          name: "Gregory Shea",
          familyGroup: "GA",
        },
      ];

      const defaultState = {
        selectedFamily: "sheas",
        givers: [...sheas],
        recipients: [...sheas],
        selected: [],
        schneiders,
        sheas,
      };
    </script>
  </body>
</html>
